{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">{{ title }}</h1>
        <a href="{% url 'customers:list' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Retour à la liste
        </a>
    </div>
    
    <form method="post" class="needs-validation" novalidate>
        {% csrf_token %}
        
        <div class="row">
            <!-- Basic Information -->
            <div class="col-lg-8">
                <div class="card shadow mb-4">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Informations générales</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="{{ form.name.id_for_label }}" class="form-label">{{ form.name.label }} *</label>
                                    {{ form.name }}
                                    {% if form.name.errors %}
                                        <div class="invalid-feedback d-block">{{ form.name.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.customer_type.id_for_label }}" class="form-label">{{ form.customer_type.label }}</label>
                                    {{ form.customer_type }}
                                    {% if form.customer_type.errors %}
                                        <div class="invalid-feedback d-block">{{ form.customer_type.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.activity.id_for_label }}" class="form-label">{{ form.activity.label }}</label>
                            {{ form.activity }}
                            {% if form.activity.errors %}
                                <div class="invalid-feedback d-block">{{ form.activity.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Address Information -->
                <div class="card shadow mb-4">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Adresse</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="{{ form.address_line1.id_for_label }}" class="form-label">{{ form.address_line1.label }} *</label>
                            {{ form.address_line1 }}
                            {% if form.address_line1.errors %}
                                <div class="invalid-feedback d-block">{{ form.address_line1.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.address_line2.id_for_label }}" class="form-label">{{ form.address_line2.label }}</label>
                            {{ form.address_line2 }}
                            {% if form.address_line2.errors %}
                                <div class="invalid-feedback d-block">{{ form.address_line2.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.city.id_for_label }}" class="form-label">{{ form.city.label }} *</label>
                                    {{ form.city }}
                                    {% if form.city.errors %}
                                        <div class="invalid-feedback d-block">{{ form.city.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="{{ form.postal_code.id_for_label }}" class="form-label">{{ form.postal_code.label }} *</label>
                                    {{ form.postal_code }}
                                    {% if form.postal_code.errors %}
                                        <div class="invalid-feedback d-block">{{ form.postal_code.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="{{ form.state.id_for_label }}" class="form-label">{{ form.state.label }}</label>
                                    {{ form.state }}
                                    {% if form.state.errors %}
                                        <div class="invalid-feedback d-block">{{ form.state.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Contact Information -->
                <div class="card shadow mb-4">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Contact</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.phone.id_for_label }}" class="form-label">{{ form.phone.label }}</label>
                                    {{ form.phone }}
                                    {% if form.phone.errors %}
                                        <div class="invalid-feedback d-block">{{ form.phone.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.fax.id_for_label }}" class="form-label">{{ form.fax.label }}</label>
                                    {{ form.fax }}
                                    {% if form.fax.errors %}
                                        <div class="invalid-feedback d-block">{{ form.fax.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.email.id_for_label }}" class="form-label">{{ form.email.label }}</label>
                                    {{ form.email }}
                                    {% if form.email.errors %}
                                        <div class="invalid-feedback d-block">{{ form.email.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Legal Information -->
                <div class="card shadow mb-4">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Identifiants légaux</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="{{ form.nis.id_for_label }}" class="form-label">{{ form.nis.label }}</label>
                                    {{ form.nis }}
                                    {% if form.nis.errors %}
                                        <div class="invalid-feedback d-block">{{ form.nis.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="{{ form.rc.id_for_label }}" class="form-label">{{ form.rc.label }}</label>
                                    {{ form.rc }}
                                    {% if form.rc.errors %}
                                        <div class="invalid-feedback d-block">{{ form.rc.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="{{ form.art.id_for_label }}" class="form-label">{{ form.art.label }}</label>
                                    {{ form.art }}
                                    {% if form.art.errors %}
                                        <div class="invalid-feedback d-block">{{ form.art.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="{{ form.nif.id_for_label }}" class="form-label">{{ form.nif.label }}</label>
                                    {{ form.nif }}
                                    {% if form.nif.errors %}
                                        <div class="invalid-feedback d-block">{{ form.nif.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Product Subscriptions -->
                <div class="card shadow mb-4" id="subscriptions-section" style="display: none;">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-success">
                            <i class="fas fa-box me-2"></i>Abonnements produits
                        </h6>
                    </div>
                    <div class="card-body">
                        {{ formset.management_form }}
                        
                        <div id="subscription-forms">
                            {% for form in formset %}
                                <div class="subscription-form border rounded p-3 mb-3" data-form-index="{{ forloop.counter0 }}">
                                    <div class="row align-items-end">
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label">Produit</label>
                                                {{ form.product }}
                                                {% if form.product.errors %}
                                                    <div class="text-danger small">{{ form.product.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="mb-3">
                                                <label class="form-label">Montant (DA)</label>
                                                {{ form.fixed_payment_amount }}
                                                {% if form.fixed_payment_amount.errors %}
                                                    <div class="text-danger small">{{ form.fixed_payment_amount.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="mb-3">
                                                <label class="form-label">Qté max</label>
                                                {{ form.max_quantity_allowed }}
                                                {% if form.max_quantity_allowed.errors %}
                                                    <div class="text-danger small">{{ form.max_quantity_allowed.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="mb-3">
                                                <label class="form-label">Cycle</label>
                                                {{ form.billing_cycle }}
                                                {% if form.billing_cycle.errors %}
                                                    <div class="text-danger small">{{ form.billing_cycle.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="mb-3">
                                                <label class="form-label">Début</label>
                                                {{ form.start_date }}
                                                {% if form.start_date.errors %}
                                                    <div class="text-danger small">{{ form.start_date.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-1">
                                            <div class="mb-3 text-center">
                                                {% if form.DELETE %}
                                                    {{ form.DELETE }}
                                                    <label class="form-label text-danger small">Suppr.</label>
                                                {% endif %}
                                                {% if not forloop.first %}
                                                    <button type="button" class="btn btn-sm btn-outline-danger remove-subscription" title="Supprimer">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label">Date fin (optionnel)</label>
                                                {{ form.end_date }}
                                                {% if form.end_date.errors %}
                                                    <div class="text-danger small">{{ form.end_date.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-check mt-4">
                                                {{ form.is_active }}
                                                <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                                    Actif
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {% for hidden in form.hidden_fields %}
                                        {{ hidden }}
                                    {% endfor %}
                                </div>
                            {% endfor %}
                        </div>
                        
                        <button type="button" id="add-subscription" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-plus me-2"></i>Ajouter un abonnement
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Commercial Settings -->
            <div class="col-lg-4">
                <!-- Subscription Settings -->
                <div class="card shadow mb-4">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-success">Paramètres d'abonnement</h6>
                    </div>
                    <div class="card-body">
                        <div class="form-check mb-3">
                            {{ form.is_subscriber }}
                            <label class="form-check-label" for="{{ form.is_subscriber.id_for_label }}">
                                {{ form.is_subscriber.label }}
                            </label>
                            <small class="form-text text-muted d-block">
                                Cochez pour activer les abonnements produits
                            </small>
                        </div>
                    </div>
                </div>
                
                <div class="card shadow mb-4">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Paramètres commerciaux</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="{{ form.credit_limit.id_for_label }}" class="form-label">{{ form.credit_limit.label }}</label>
                            <div class="input-group">
                                {{ form.credit_limit }}
                                <span class="input-group-text">DA</span>
                            </div>
                            {% if form.credit_limit.errors %}
                                <div class="invalid-feedback d-block">{{ form.credit_limit.errors.0 }}</div>
                            {% endif %}
                            <small class="form-text text-muted">
                                Limite de crédit autorisée
                            </small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.payment_terms.id_for_label }}" class="form-label">{{ form.payment_terms.label }}</label>
                            <div class="input-group">
                                {{ form.payment_terms }}
                                <span class="input-group-text">jours</span>
                            </div>
                            {% if form.payment_terms.errors %}
                                <div class="invalid-feedback d-block">{{ form.payment_terms.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.discount_rate.id_for_label }}" class="form-label">{{ form.discount_rate.label }}</label>
                            <div class="input-group">
                                {{ form.discount_rate }}
                                <span class="input-group-text">%</span>
                            </div>
                            {% if form.discount_rate.errors %}
                                <div class="invalid-feedback d-block">{{ form.discount_rate.errors.0 }}</div>
                            {% endif %}
                            <small class="form-text text-muted">
                                Taux de remise standard
                            </small>
                        </div>
                        
                        <div class="form-check">
                            {{ form.is_active }}
                            <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                {{ form.is_active.label }}
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="card shadow">
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Enregistrer
                            </button>
                            <a href="{% url 'customers:list' %}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Annuler
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const subscriberCheckbox = document.getElementById('{{ form.is_subscriber.id_for_label }}');
    const subscriptionsSection = document.getElementById('subscriptions-section');
    const addSubscriptionBtn = document.getElementById('add-subscription');
    const subscriptionForms = document.getElementById('subscription-forms');
    
    // Get today's date for default start date
    const today = new Date().toISOString().split('T')[0];
    
    function toggleSubscriberFields() {
        if (subscriberCheckbox.checked) {
            subscriptionsSection.style.display = 'block';
        } else {
            subscriptionsSection.style.display = 'none';
        }
    }
    
    function addSubscriptionForm() {
        const totalForms = document.querySelector('#id_subscriptions-TOTAL_FORMS');
        const formCount = parseInt(totalForms.value);
        
        // Clone the first form and update its indices
        const emptyForm = document.querySelector('.subscription-form').cloneNode(true);
        const formRegex = RegExp(`subscriptions-(\\d){1}-`, 'g');
        
        emptyForm.innerHTML = emptyForm.innerHTML.replace(formRegex, `subscriptions-${formCount}-`);
        emptyForm.setAttribute('data-form-index', formCount);
        
        // Clear values and set default start date
        const inputs = emptyForm.querySelectorAll('input, select');
        inputs.forEach(input => {
            if (input.type === 'checkbox') {
                input.checked = input.name.includes('is_active');
            } else if (input.type === 'date' && input.name.includes('start_date')) {
                input.value = today;
            } else if (input.type !== 'hidden') {
                input.value = '';
            }
        });
        
        // Add remove button if it doesn't exist
        const removeBtn = emptyForm.querySelector('.remove-subscription');
        if (!removeBtn) {
            const lastCol = emptyForm.querySelector('.col-md-1');
            const btnHtml = `<button type="button" class="btn btn-sm btn-outline-danger remove-subscription" title="Supprimer">
                                <i class="fas fa-trash"></i>
                            </button>`;
            lastCol.querySelector('.mb-3').innerHTML += btnHtml;
        }
        
        subscriptionForms.appendChild(emptyForm);
        totalForms.value = formCount + 1;
        
        // Attach remove handler to new form
        attachRemoveHandler(emptyForm);
    }
    
    function attachRemoveHandler(form) {
        const removeBtn = form.querySelector('.remove-subscription');
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                // Mark for deletion if editing existing, otherwise just remove
                const deleteCheckbox = form.querySelector('input[name$="-DELETE"]');
                if (deleteCheckbox) {
                    deleteCheckbox.checked = true;
                    form.style.display = 'none';
                } else {
                    form.remove();
                    // Update form count
                    const totalForms = document.querySelector('#id_subscriptions-TOTAL_FORMS');
                    totalForms.value = parseInt(totalForms.value) - 1;
                }
            });
        }
    }
    
    // Initialize event handlers
    subscriberCheckbox.addEventListener('change', toggleSubscriberFields);
    addSubscriptionBtn.addEventListener('click', addSubscriptionForm);
    
    // Attach remove handlers to existing forms
    document.querySelectorAll('.subscription-form').forEach(attachRemoveHandler);
    
    // Set default start date for existing forms if empty
    document.querySelectorAll('input[name$="-start_date"]').forEach(input => {
        if (!input.value) {
            input.value = today;
        }
    });
    
    // Initialize on page load
    toggleSubscriberFields();
});
</script>
{% endblock %}