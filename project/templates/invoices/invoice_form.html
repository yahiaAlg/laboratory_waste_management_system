{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">{{ title }}</h1>
        <a href="{% url 'invoices:list' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Retour à la liste
        </a>
    </div>
    
    <form method="post" id="invoiceForm">
        {% csrf_token %}
        
        <div class="row">
            <!-- Invoice Details -->
            <div class="col-lg-8">
                <div class="card shadow mb-4">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Informations de la facture</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.customer.id_for_label }}" class="form-label">{{ form.customer.label }}</label>
                                    {{ form.customer }}
                                    {% if form.customer.errors %}
                                        <div class="invalid-feedback d-block">{{ form.customer.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="{{ form.invoice_date.id_for_label }}" class="form-label">{{ form.invoice_date.label }}</label>
                                    {{ form.invoice_date }}
                                    {% if form.invoice_date.errors %}
                                        <div class="invalid-feedback d-block">{{ form.invoice_date.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="{{ form.due_date.id_for_label }}" class="form-label">{{ form.due_date.label }}</label>
                                    {{ form.due_date }}
                                    {% if form.due_date.errors %}
                                        <div class="invalid-feedback d-block">{{ form.due_date.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.payment_method.id_for_label }}" class="form-label">{{ form.payment_method.label }}</label>
                                    {{ form.payment_method }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.driver_name.id_for_label }}" class="form-label">{{ form.driver_name.label }}</label>
                                    {{ form.driver_name }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.vehicle_registration.id_for_label }}" class="form-label">{{ form.vehicle_registration.label }}</label>
                                    {{ form.vehicle_registration }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="{{ form.destination.id_for_label }}" class="form-label">{{ form.destination.label }}</label>
                                    {{ form.destination }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Invoice Lines -->
                <div class="card shadow mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-primary">Lignes de facture</h6>
                        <button type="button" class="btn btn-sm btn-success" id="addLineBtn">
                            <i class="fas fa-plus me-1"></i>Ajouter une ligne
                        </button>
                    </div>
                    <div class="card-body p-0">
                        {{ formset.management_form }}
                        
                        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                            <table class="table table-bordered mb-0" id="invoice-lines-table">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th style="min-width: 200px;">Produit/Service</th>
                                        <th style="min-width: 120px;">Référence</th>
                                        <th style="min-width: 200px;">Désignation</th>
                                        <th style="min-width: 80px;">Unité</th>
                                        <th style="min-width: 100px;">Quantité</th>
                                        <th style="min-width: 120px;">Prix unit. HT</th>
                                        <th style="min-width: 120px;">Total HT</th>
                                        <th style="min-width: 80px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="invoice-lines-tbody">
                                    {% for form in formset %}
                                        <tr class="invoice-line-row">
                                            <td>
                                                {{ form.product }}
                                                {{ form.id }}
                                            </td>
                                            <td>{{ form.reference }}</td>
                                            <td>{{ form.description }}</td>
                                            <td>{{ form.unit }}</td>
                                            <td>{{ form.quantity }}</td>
                                            <td>{{ form.unit_price }}</td>
                                            <td class="line-total">0.00</td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-danger remove-line">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                                {{ form.DELETE }}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Notes -->
                <div class="card shadow mb-4">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Notes</h6>
                    </div>
                    <div class="card-body">
                        {{ form.notes }}
                    </div>
                </div>
            </div>
            
            <!-- Summary -->
            <div class="col-lg-4">
                <div class="card shadow mb-4 position-sticky" style="top: 20px;">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Récapitulatif</h6>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="{{ form.discount_amount.id_for_label }}" class="form-label">{{ form.discount_amount.label }}</label>
                                {{ form.discount_amount }}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.timbre_fiscal.id_for_label }}" class="form-label">{{ form.timbre_fiscal.label }}</label>
                                {{ form.timbre_fiscal }}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.other_taxes.id_for_label }}" class="form-label">{{ form.other_taxes.label }}</label>
                            {{ form.other_taxes }}
                        </div>
                        
                        <hr>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>TOTAL H.T.:</span>
                            <span id="subtotal-display">0.00 DA</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>REMISE:</span>
                            <span id="discount-display">0.00 DA</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span id="tva-label">T.V.A. (19%):</span>
                            <span id="tva-display">0.00 DA</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>TIMBRE:</span>
                            <span id="timbre-display">0.00 DA</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>AUTRES TAXES:</span>
                            <span id="other-taxes-display">0.00 DA</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between fw-bold">
                            <span>TOTAL FACTURE:</span>
                            <span id="total-display">0.00 DA</span>
                        </div>
                        
                        <div class="mt-4 d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Enregistrer
                            </button>
                            <a href="{% url 'invoices:list' %}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Annuler
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
.table-responsive {
    border-radius: 0.375rem;
}

.sticky-top {
    position: sticky;
    top: 0;
    z-index: 10;
}

.invoice-line-row td {
    vertical-align: middle;
}

.invoice-line-row select,
.invoice-line-row input {
    min-width: 100%;
}

@media (max-width: 768px) {
    .container-fluid {
        padding-left: 10px;
        padding-right: 10px;
    }
    
    .table-responsive {
        font-size: 0.875rem;
    }
    
    .position-sticky {
        position: relative !important;
    }
}
</style>
<input
type="hidden"
name="tva_rate"
value="{{ company.tva_rate|default:19 }}"
>
{% endblock %}
{% comment %} hidden input for tva rate {% endcomment %}

{% block extra_js %}
<script>

// Get company data from Django context
// get the tva rate  from the company object 
// Get company data from Django context - FIXED VERSION
const tvaRateInput = document.querySelector('input[name="tva_rate"]');
const tvaRateValue = tvaRateInput ? parseFloat(tvaRateInput.value) : 19;

// Validate and ensure we have a valid number
const validTvaRate = isNaN(tvaRateValue) ? 19 : tvaRateValue;

const COMPANY_DATA = {
    tva_rate: validTvaRate,
};

const TVA_RATE = COMPANY_DATA.tva_rate / 100;

// Add debugging to see what values we're getting
console.log('TVA Rate from input:', tvaRateInput?.value);
console.log('Parsed TVA Rate:', validTvaRate);
console.log('Final TVA Rate (decimal):', TVA_RATE);



let lineIndex = {{ formset.total_form_count }};

// Add new invoice line
document.getElementById('addLineBtn').addEventListener('click', function() {
    const tbody = document.getElementById('invoice-lines-tbody');
    const totalForms = document.getElementById('id_invoiceline_set-TOTAL_FORMS');
    
    const newRow = tbody.insertRow();
    newRow.className = 'invoice-line-row';
    newRow.innerHTML = `
        <td>
            <select name="invoiceline_set-${lineIndex}-product" class="form-select product-select" id="id_invoiceline_set-${lineIndex}-product">
                <option value="">---------</option>
                {% for product in products %}
                <option value="{{ product.pk }}">{{ product.code }} - {{ product.name }}</option>
                {% endfor %}
            </select>
            <input type="hidden" name="invoiceline_set-${lineIndex}-id" id="id_invoiceline_set-${lineIndex}-id">
        </td>
        <td><input type="text" name="invoiceline_set-${lineIndex}-reference" class="form-control" id="id_invoiceline_set-${lineIndex}-reference"></td>
        <td><input type="text" name="invoiceline_set-${lineIndex}-description" class="form-control" id="id_invoiceline_set-${lineIndex}-description"></td>
        <td><input type="text" name="invoiceline_set-${lineIndex}-unit" class="form-control" id="id_invoiceline_set-${lineIndex}-unit"></td>
        <td><input type="number" name="invoiceline_set-${lineIndex}-quantity" class="form-control quantity-input" step="0.01" id="id_invoiceline_set-${lineIndex}-quantity"></td>
        <td><input type="number" name="invoiceline_set-${lineIndex}-unit_price" class="form-control price-input" step="0.01" id="id_invoiceline_set-${lineIndex}-unit_price"></td>
        <td class="line-total">0.00</td>
        <td>
            <button type="button" class="btn btn-sm btn-danger remove-line">
                <i class="fas fa-trash"></i>
            </button>
            <input type="checkbox" name="invoiceline_set-${lineIndex}-DELETE" style="display:none;" id="id_invoiceline_set-${lineIndex}-DELETE">
        </td>
    `;
    
    lineIndex++;
    totalForms.value = lineIndex;
    
    // Add event listeners to new row
    addLineEventListeners(newRow);
    calculateTotals();
});

// Remove invoice line
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-line') || e.target.closest('.remove-line')) {
        const row = e.target.closest('tr');
        const deleteCheckbox = row.querySelector('input[name$="-DELETE"]');
        
        if (deleteCheckbox) {
            deleteCheckbox.checked = true;
            row.style.display = 'none';
        } else {
            row.remove();
        }
        
        calculateTotals();
    }
});

// Product selection change - FIXED VERSION
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('product-select')) {
        const productId = e.target.value;
        const row = e.target.closest('tr');
        
        if (productId) {
            // Show loading state
            const descriptionField = row.querySelector('[name*="-description"]');
            const unitField = row.querySelector('[name*="-unit"]');
            const priceField = row.querySelector('[name*="-unit_price"]');
            const referenceField = row.querySelector('[name*="-reference"]');
            
            // Clear fields first
            descriptionField.value = '';
            unitField.value = '';
            priceField.value = '';
            referenceField.value = '';
            
            // Add loading indicator
            descriptionField.placeholder = 'Chargement...';
            
            // Make AJAX request
            fetch('/invoices/api/product-data/?product_id=' + productId, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Remove loading indicator
                descriptionField.placeholder = '';
                
                // Populate fields with product data
                if (data.description) {
                    descriptionField.value = data.description;
                }
                if (data.unit) {
                    unitField.value = data.unit;
                }
                if (data.unit_price) {
                    priceField.value = parseFloat(data.unit_price).toFixed(2);
                }
                if (data.code) {
                    referenceField.value = data.code;
                }
                
                // Calculate line total after populating price
                calculateLineTotal(row);
            })
            .catch(error => {
                console.error('Error fetching product data:', error);
                descriptionField.placeholder = 'Erreur lors du chargement';
                
                // Show user-friendly error message
                alert('Erreur lors du chargement des données du produit. Veuillez réessayer.');
            });
        } else {
            // Clear all fields if no product selected
            row.querySelector('[name*="-description"]').value = '';
            row.querySelector('[name*="-unit"]').value = '';
            row.querySelector('[name*="-unit_price"]').value = '';
            row.querySelector('[name*="-reference"]').value = '';
            calculateLineTotal(row);
        }
    }
});

// Calculate line total
function calculateLineTotal(row) {
    const quantityInput = row.querySelector('.quantity-input') || row.querySelector('[name*="-quantity"]');
    const priceInput = row.querySelector('.price-input') || row.querySelector('[name*="-unit_price"]');
    const totalCell = row.querySelector('.line-total');
    
    if (quantityInput && priceInput && totalCell) {
        const quantity = parseFloat(quantityInput.value) || 0;
        const unitPrice = parseFloat(priceInput.value) || 0;
        const total = quantity * unitPrice;
        
        totalCell.textContent = total.toFixed(2);
        calculateTotals();
    }
}

// Add event listeners to existing rows
function addLineEventListeners(row) {
    const quantityInput = row.querySelector('.quantity-input') || row.querySelector('[name*="-quantity"]');
    const priceInput = row.querySelector('.price-input') || row.querySelector('[name*="-unit_price"]');
    
    if (quantityInput) {
        quantityInput.addEventListener('input', () => calculateLineTotal(row));
        quantityInput.addEventListener('change', () => calculateLineTotal(row));
    }
    if (priceInput) {
        priceInput.addEventListener('input', () => calculateLineTotal(row));
        priceInput.addEventListener('change', () => calculateLineTotal(row));
    }
}

// Calculate invoice totals
// Calculate invoice totals - IMPROVED VERSION
function calculateTotals() {
    let subtotal = 0;
    
    document.querySelectorAll('.invoice-line-row:not([style*="display: none"])').forEach(row => {
        const lineTotal = parseFloat(row.querySelector('.line-total').textContent) || 0;
        subtotal += lineTotal;
    });
    
    const discountInput = document.getElementById('id_discount_amount');
    const timbreInput = document.getElementById('id_timbre_fiscal');
    const otherTaxesInput = document.getElementById('id_other_taxes');
    
    // Ensure all values are valid numbers
    const discount = discountInput ? (parseFloat(discountInput.value) || 0) : 0;
    const timbre = timbreInput ? (parseFloat(timbreInput.value) || 0) : 0;
    const otherTaxes = otherTaxesInput ? (parseFloat(otherTaxesInput.value) || 0) : 0;
    
    const discountedSubtotal = Math.max(0, subtotal - discount);
    
    // Validate TVA_RATE before calculation
    const tvaRate = isNaN(TVA_RATE) ? 0.19 : TVA_RATE; // Default to 19% if invalid
    const tva = discountedSubtotal * tvaRate;
    
    const total = discountedSubtotal + tva + timbre + otherTaxes;
    
    // Debug logging
    console.log('Calculation values:', {
        subtotal,
        discount,
        discountedSubtotal,
        tvaRate,
        tva,
        timbre,
        otherTaxes,
        total
    });
    
    // Update display elements with validation
    const subtotalDisplay = document.getElementById('subtotal-display');
    const discountDisplay = document.getElementById('discount-display');
    const tvaDisplay = document.getElementById('tva-display');
    const timbreDisplay = document.getElementById('timbre-display');
    const otherTaxesDisplay = document.getElementById('other-taxes-display');
    const totalDisplay = document.getElementById('total-display');
    
    if (subtotalDisplay) subtotalDisplay.textContent = (isNaN(subtotal) ? 0 : subtotal).toFixed(2) + ' DA';
    if (discountDisplay) discountDisplay.textContent = (isNaN(discount) ? 0 : discount).toFixed(2) + ' DA';
    if (tvaDisplay) tvaDisplay.textContent = (isNaN(tva) ? 0 : tva).toFixed(2) + ' DA';
    if (timbreDisplay) timbreDisplay.textContent = (isNaN(timbre) ? 0 : timbre).toFixed(2) + ' DA';
    if (otherTaxesDisplay) otherTaxesDisplay.textContent = (isNaN(otherTaxes) ? 0 : otherTaxes).toFixed(2) + ' DA';
    if (totalDisplay) totalDisplay.textContent = (isNaN(total) ? 0 : total).toFixed(2) + ' DA';
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Update TVA label with current rate
    const tvaLabel = document.getElementById('tva-label');
    if (tvaLabel) {
        tvaLabel.textContent = `T.V.A. (${COMPANY_DATA.tva_rate}%):`;
    }
    
    // Add event listeners to existing rows
    document.querySelectorAll('.invoice-line-row').forEach(addLineEventListeners);
    
    // Add event listeners to summary fields
    ['id_discount_amount', 'id_timbre_fiscal', 'id_other_taxes'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('input', calculateTotals);
            element.addEventListener('change', calculateTotals);
        }
    });
    
    // Initial calculation
    calculateTotals();
});
</script>
{% endblock %}