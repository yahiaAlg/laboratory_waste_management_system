{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">{{ title }}</h1>
        <a href="{% url 'invoices:list' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Retour à la liste
        </a>
    </div>
    
    <form method="post" id="invoiceForm">
        {% csrf_token %}
        
        <div class="row">
            <!-- Invoice Details -->
            <div class="col-lg-8">
                <div class="card shadow mb-4">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Informations de la facture</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.customer.id_for_label }}" class="form-label">{{ form.customer.label }}</label>
                                    {{ form.customer }}
                                    {% if form.customer.errors %}
                                        <div class="invalid-feedback d-block">{{ form.customer.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="{{ form.invoice_date.id_for_label }}" class="form-label">{{ form.invoice_date.label }}</label>
                                    {{ form.invoice_date }}
                                    {% if form.invoice_date.errors %}
                                        <div class="invalid-feedback d-block">{{ form.invoice_date.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="{{ form.due_date.id_for_label }}" class="form-label">{{ form.due_date.label }}</label>
                                    {{ form.due_date }}
                                    {% if form.due_date.errors %}
                                        <div class="invalid-feedback d-block">{{ form.due_date.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.payment_method.id_for_label }}" class="form-label">{{ form.payment_method.label }}</label>
                                    {{ form.payment_method }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.driver_name.id_for_label }}" class="form-label">{{ form.driver_name.label }}</label>
                                    {{ form.driver_name }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.vehicle_registration.id_for_label }}" class="form-label">{{ form.vehicle_registration.label }}</label>
                                    {{ form.vehicle_registration }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="{{ form.destination.id_for_label }}" class="form-label">{{ form.destination.label }}</label>
                                    {{ form.destination }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Customer Subscription Info -->
                <div class="card shadow mb-4" id="subscription-info" style="display: none;">
                    <div class="card-header bg-info text-white">
                        <h6 class="m-0 font-weight-bold">
                            <i class="fas fa-crown me-2"></i>Client abonné - Produits avec tarifs préférentiels
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            Ce client dispose d'abonnements actifs. Les prix préférentiels seront appliqués automatiquement.
                        </div>
                        <div id="subscriptions-list" class="row">
                            <!-- Subscription details will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <!-- Invoice Lines -->
                <div class="card shadow mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-primary">Lignes de facture</h6>
                        <button type="button" class="btn btn-sm btn-success" id="addLineBtn">
                            <i class="fas fa-plus me-1"></i>Ajouter une ligne
                        </button>
                    </div>
                    <div class="card-body p-0">
                        {{ formset.management_form }}
                        
                        <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                            <table class="table table-bordered table-sm mb-0" id="invoice-lines-table">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th style="min-width: 180px;">Produit/Service</th>
                                        <th style="min-width: 100px;">Référence</th>
                                        <th style="min-width: 180px;">Désignation</th>
                                        <th style="min-width: 70px;">Unité</th>
                                        <th style="min-width: 90px;">Quantité</th>
                                        <th style="min-width: 110px;">Prix unit. HT</th>
                                        <th style="min-width: 130px;">Date de ligne</th>
                                        <th style="min-width: 100px;">Total ligne</th>
                                        <th style="min-width: 100px;">Stock restant</th>
                                        <th style="min-width: 80px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="invoice-lines-tbody">
                                    {% for form in formset %}
                                        <tr class="invoice-line-row">
                                            <td>
                                                {{ form.product }}
                                                {{ form.id }}
                                            </td>
                                            <td>{{ form.reference }}</td>
                                            <td>{{ form.description }}</td>
                                            <td>{{ form.unit }}</td>
                                            <td>{{ form.quantity }}</td>
                                            <td>{{ form.unit_price }}</td>
                                            <td>{{ form.line_date }}</td>
                                            <td class="line-total fw-bold">0.00 DA</td>
                                            <td class="stock-remaining text-muted">--</td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-danger remove-line">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                                {{ form.DELETE }}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Notes -->
                <div class="card shadow mb-4">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Notes</h6>
                    </div>
                    <div class="card-body">
                        {{ form.notes }}
                    </div>
                </div>
            </div>
            
            <!-- Summary -->
            <div class="col-lg-4">
                <div class="card shadow mb-4 position-sticky" style="top: 20px;">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Récapitulatif</h6>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="{{ form.discount_amount.id_for_label }}" class="form-label">{{ form.discount_amount.label }}</label>
                                {{ form.discount_amount }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Timbre fiscal</label>
                                <input type="text" class="form-control" id="timbre-display-input" readonly style="background-color: #f8f9fa;">
                                {{ form.timbre_fiscal }}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.other_taxes.id_for_label }}" class="form-label">{{ form.other_taxes.label }}</label>
                            {{ form.other_taxes }}
                        </div>
                        
                        <hr>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>TOTAL H.T.:</span>
                            <span id="subtotal-display">0.00 DA</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>REMISE:</span>
                            <span id="discount-display">0.00 DA</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span id="tva-label">T.V.A:</span>
                            <span id="tva-display">0.00 DA</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>TIMBRE:</span>
                            <span id="timbre-display">0.00 DA</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>AUTRES TAXES:</span>
                            <span id="other-taxes-display">0.00 DA</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between fw-bold">
                            <span>TOTAL FACTURE:</span>
                            <span id="total-display">0.00 DA</span>
                        </div>
                        
                        <div class="mt-4 d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Enregistrer
                            </button>
                            <a href="{% url 'invoices:list' %}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Annuler
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
.table-responsive {
    border-radius: 0.375rem;
}

.sticky-top {
    position: sticky;
    top: 0;
    z-index: 10;
}

.invoice-line-row td {
    vertical-align: middle;
    padding: 0.5rem;
}

.invoice-line-row select,
.invoice-line-row input {
    min-width: 100%;
    font-size: 0.875rem;
}

.subscription-badge {
    font-size: 0.75em;
    margin-left: 5px;
}

.subscription-info {
    font-size: 0.875em;
    color: #6c757d;
}

.quantity-warning {
    color: #dc3545;
    font-size: 0.75em;
}

.line-total {
    background-color: #f8f9fa;
    text-align: right;
    font-family: monospace;
}

.stock-remaining {
    text-align: center;
    font-size: 0.875rem;
}

.stock-warning {
    color: #dc3545;
    font-weight: bold;
}

.stock-ok {
    color: #198754;
}

@media (max-width: 768px) {
    .container-fluid {
        padding-left: 10px;
        padding-right: 10px;
    }
    
    .table-responsive {
        font-size: 0.875rem;
    }
    
    .position-sticky {
        position: relative !important;
    }
}
</style>

<input type="hidden" name="tva_rate" value="{{ company.tva_rate|default:0 }}">

{% endblock %}

{% block extra_js %}
<script>
// Get company data from Django context
const tvaRateInput = document.querySelector('input[name="tva_rate"]');
const tvaRateValue = tvaRateInput ? parseFloat(tvaRateInput.value) : 19;
const validTvaRate = isNaN(tvaRateValue) ? 19 : tvaRateValue;

const COMPANY_DATA = {
    tva_rate: validTvaRate,
};

const TVA_RATE = COMPANY_DATA.tva_rate / 100;

let lineIndex = {{ formset.total_form_count }};
let customerSubscriptions = {};
let currentCustomerId = null;
let currentCustomerHasLegalInfo = false;
let productStockData = {}; // Store product stock information

// Initialize due date for new invoices
const dueDateInput = document.querySelector('input[name="due_date"]');
const invoiceDateInput = document.querySelector('input[name="invoice_date"]');

// Auto-update due date when invoice date changes
invoiceDateInput.addEventListener('change', function() {
    if (this.value) {
        const invoiceDate = new Date(this.value);
        const dueDate = new Date(invoiceDate);
        dueDate.setMonth(dueDate.getMonth() + 1);
        dueDateInput.value = dueDate.toISOString().split('T')[0];
    }
});

// Set initial due date if empty
if (!dueDateInput.value && invoiceDateInput.value) {
    const invoiceDate = new Date(invoiceDateInput.value);
    const dueDate = new Date(invoiceDate);
    dueDate.setMonth(dueDate.getMonth() + 1);
    dueDateInput.value = dueDate.toISOString().split('T')[0];
}

// Calculate timbre fiscal based on amount (HT + TVA)
function calculateTimbreFiscal(amountHtPlusTva, paymentMethod) {
    if (paymentMethod !== 'cash') {
        return 0;
    }
    
    if (amountHtPlusTva < 300) {
        return 5.00;
    } else if (amountHtPlusTva < 30000) {
        return amountHtPlusTva * 0.01;
    } else if (amountHtPlusTva < 100000) {
        return amountHtPlusTva * 0.015;
    } else {
        return amountHtPlusTva * 0.02;
    }
}

// Customer selection change handler
document.addEventListener('change', function(e) {
    if (e.target.name === 'customer') {
        const customerId = e.target.value;
        currentCustomerId = customerId;
        
        if (customerId) {
            loadCustomerSubscriptions(customerId);
            checkCustomerLegalInfo(customerId);
        } else {
            hideSubscriptionInfo();
            customerSubscriptions = {};
            currentCustomerHasLegalInfo = false;
            calculateTotals();
        }
    }
});

// Check if customer has legal information
function checkCustomerLegalInfo(customerId) {
    fetch(`/invoices/api/customer-legal-info/?customer_id=${customerId}`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        currentCustomerHasLegalInfo = data.has_legal_info || false;
        
        const tvaLabel = document.getElementById('tva-label');
        if (tvaLabel) {
            if (currentCustomerHasLegalInfo) {
                tvaLabel.textContent = `T.V.A. (${COMPANY_DATA.tva_rate}%):`;
            } else {
                tvaLabel.textContent = `T.V.A. (0%):`;
            }
        }
        
        calculateTotals();
    })
    .catch(error => {
        console.error('Error checking customer legal info:', error);
        currentCustomerHasLegalInfo = false;
        calculateTotals();
    });
}

// Load customer subscriptions
function loadCustomerSubscriptions(customerId) {
    fetch(`/invoices/api/customer-subscriptions/?customer_id=${customerId}`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        customerSubscriptions = {};
        
        if (data.has_subscriptions) {
            data.subscriptions.forEach(sub => {
                customerSubscriptions[sub.product_id] = sub;
            });
            
            showSubscriptionInfo(data.subscriptions);
        } else {
            hideSubscriptionInfo();
        }
        
        updateExistingLines();
    })
    .catch(error => {
        console.error('Error loading customer subscriptions:', error);
        hideSubscriptionInfo();
    });
}

// Show subscription information
function showSubscriptionInfo(subscriptions) {
    const subscriptionCard = document.getElementById('subscription-info');
    const subscriptionsList = document.getElementById('subscriptions-list');
    
    let html = '';
    subscriptions.forEach(sub => {
        html += `
            <div class="col-md-6 mb-3">
                <div class="card bg-light">
                    <div class="card-body p-3">
                        <h6 class="card-title mb-2">
                            <i class="fas fa-box me-1"></i>${sub.product_code} - ${sub.product_name}
                        </h6>
                        <div class="subscription-info">
                            <div><strong>Prix abonné:</strong> ${parseFloat(sub.fixed_payment_amount).toFixed(2)} DA</div>
                            <div><strong>Quantité restante:</strong> ${parseFloat(sub.remaining_quantity).toFixed(2)} / ${parseFloat(sub.max_quantity).toFixed(2)}</div>
                            <div><strong>Cycle:</strong> ${sub.billing_cycle}</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    subscriptionsList.innerHTML = html;
    subscriptionCard.style.display = 'block';
}

// Hide subscription information
function hideSubscriptionInfo() {
    const subscriptionCard = document.getElementById('subscription-info');
    subscriptionCard.style.display = 'none';
}

// Update existing lines with subscription info
function updateExistingLines() {
    document.querySelectorAll('.invoice-line-row').forEach(row => {
        const productSelect = row.querySelector('.product-select');
        if (productSelect && productSelect.value) {
            updateLineSubscriptionInfo(row, productSelect.value);
        }
    });
}

// Add new invoice line
document.getElementById('addLineBtn').addEventListener('click', function() {
    const tbody = document.getElementById('invoice-lines-tbody');
    const totalForms = document.getElementById('id_invoiceline_set-TOTAL_FORMS');
    
    const newRow = tbody.insertRow();
    newRow.className = 'invoice-line-row';
    
    // Set current date/time for line_date
    const now = new Date();
    const currentDateTime = now.toISOString().slice(0, 16); // Format: YYYY-MM-DDTHH:MM
    
    newRow.innerHTML = `
        <td>
            <select name="invoiceline_set-${lineIndex}-product" class="form-select product-select" id="id_invoiceline_set-${lineIndex}-product">
                <option value="">---------</option>
                {% for product in products %}
                <option value="{{ product.pk }}">{{ product.code }} - {{ product.name }}</option>
                {% endfor %}
            </select>
            <input type="hidden" name="invoiceline_set-${lineIndex}-id" id="id_invoiceline_set-${lineIndex}-id">
        </td>
        <td><input type="text" name="invoiceline_set-${lineIndex}-reference" class="form-control" id="id_invoiceline_set-${lineIndex}-reference"></td>
        <td><input type="text" name="invoiceline_set-${lineIndex}-description" class="form-control" id="id_invoiceline_set-${lineIndex}-description"></td>
        <td><input type="text" name="invoiceline_set-${lineIndex}-unit" class="form-control" id="id_invoiceline_set-${lineIndex}-unit"></td>
        <td><input type="number" name="invoiceline_set-${lineIndex}-quantity" class="form-control quantity-input" step="0.01" id="id_invoiceline_set-${lineIndex}-quantity"></td>
        <td><input type="number" name="invoiceline_set-${lineIndex}-unit_price" class="form-control price-input" step="0.01" id="id_invoiceline_set-${lineIndex}-unit_price"></td>
        <td><input type="datetime-local" name="invoiceline_set-${lineIndex}-line_date" class="form-control" value="${currentDateTime}" id="id_invoiceline_set-${lineIndex}-line_date"></td>
        <td class="line-total">0.00 DA</td>
        <td class="stock-remaining text-muted">--</td>
        <td>
            <button type="button" class="btn btn-sm btn-danger remove-line">
                <i class="fas fa-trash"></i>
            </button>
            <input type="checkbox" name="invoiceline_set-${lineIndex}-DELETE" style="display:none;" id="id_invoiceline_set-${lineIndex}-DELETE">
        </td>
    `;
    
    lineIndex++;
    totalForms.value = lineIndex;
    
    addLineEventListeners(newRow);
    calculateTotals();
});

// Remove invoice line
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-line') || e.target.closest('.remove-line')) {
        const row = e.target.closest('tr');
        const deleteCheckbox = row.querySelector('input[name$="-DELETE"]');
        
        if (deleteCheckbox) {
            deleteCheckbox.checked = true;
            row.style.display = 'none';
        } else {
            row.remove();
        }
        
        calculateTotals();
    }
});

// Product selection change handler
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('product-select')) {
        const productId = e.target.value;
        const row = e.target.closest('tr');
        
        if (productId) {
            loadProductData(productId, row);
        } else {
            clearLineData(row);
        }
    }
});

// Load product data with stock information
function loadProductData(productId, row) {
    const descriptionField = row.querySelector('[name*="-description"]');
    const unitField = row.querySelector('[name*="-unit"]');
    const priceField = row.querySelector('[name*="-unit_price"]');
    const referenceField = row.querySelector('[name*="-reference"]');
    
    clearLineData(row);
    descriptionField.placeholder = 'Chargement...';
    
    let url = `/invoices/api/product-data/?product_id=${productId}`;
    if (currentCustomerId) {
        url += `&customer_id=${currentCustomerId}`;
    }
    
    fetch(url, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        descriptionField.placeholder = '';
        
        if (data.description) descriptionField.value = data.description;
        if (data.unit) unitField.value = data.unit;
        if (data.code) referenceField.value = data.code;
        
        // Store product stock data
        productStockData[productId] = {
            stock_quantity: data.stock_quantity || 0,
            is_service: data.is_service || false,
            stock_status: data.stock_status || 'N/A'
        };
        
        // Handle subscription pricing
        if (data.is_subscribed) {
            priceField.value = parseFloat(data.subscription_price).toFixed(2);
            addSubscriptionBadge(row, data);
            showQuantityWarning(row, data);
        } else {
            priceField.value = parseFloat(data.unit_price).toFixed(2);
            removeSubscriptionBadge(row);
        }
        
        // Update stock display
        updateStockDisplay(row, productId);
        calculateLineTotal(row);
    })
    .catch(error => {
        console.error('Error fetching product data:', error);
        descriptionField.placeholder = 'Erreur lors du chargement';
        alert('Erreur lors du chargement des données du produit. Veuillez réessayer.');
    });
}

// Update stock display
function updateStockDisplay(row, productId) {
    const stockCell = row.querySelector('.stock-remaining');
    const quantityInput = row.querySelector('[name*="-quantity"]');
    
    if (!stockCell || !productStockData[productId]) return;
    
    const stockData = productStockData[productId];
    const quantity = parseFloat(quantityInput.value) || 0;
    
    if (stockData.is_service) {
        stockCell.innerHTML = '<span class="text-info">Service</span>';
        stockCell.className = 'stock-remaining';
        return;
    }
    
    const remainingStock = stockData.stock_quantity - quantity;
    stockCell.textContent = remainingStock.toFixed(2);
    
    // Color coding based on remaining stock
    stockCell.className = 'stock-remaining';
    if (remainingStock < 0) {
        stockCell.classList.add('stock-warning');
        stockCell.title = 'Stock insuffisant!';
    } else if (remainingStock <= 10) {
        stockCell.classList.add('text-warning');
        stockCell.title = 'Stock faible';
    } else {
        stockCell.classList.add('stock-ok');
        stockCell.title = 'Stock suffisant';
    }
}

// Clear line data
function clearLineData(row) {
    row.querySelector('[name*="-description"]').value = '';
    row.querySelector('[name*="-unit"]').value = '';
    row.querySelector('[name*="-unit_price"]').value = '';
    row.querySelector('[name*="-reference"]').value = '';
    row.querySelector('.stock-remaining').textContent = '--';
    row.querySelector('.stock-remaining').className = 'stock-remaining text-muted';
    removeSubscriptionBadge(row);
    calculateLineTotal(row);
}

// Add subscription badge
function addSubscriptionBadge(row, data) {
    const productCell = row.querySelector('td:first-child');
    let badge = productCell.querySelector('.subscription-badge');
    
    if (!badge) {
        badge = document.createElement('span');
        badge.className = 'badge bg-info subscription-badge';
        productCell.appendChild(badge);
    }
    
    badge.innerHTML = '<i class="fas fa-crown"></i> Abonné';
    badge.title = `Prix abonné: ${data.subscription_price} DA | Restant: ${data.remaining_quantity}`;
}

// Remove subscription badge
function removeSubscriptionBadge(row) {
    const badge = row.querySelector('.subscription-badge');
    if (badge) badge.remove();
    
    const warning = row.querySelector('.quantity-warning');
    if (warning) warning.remove();
}

// Show quantity warning for subscriptions
function showQuantityWarning(row, data) {
    const quantityCell = row.querySelector('td:nth-child(5)');
    let warning = quantityCell.querySelector('.quantity-warning');
    
    if (!warning) {
        warning = document.createElement('div');
        warning.className = 'quantity-warning';
        quantityCell.appendChild(warning);
    }
    
    const remaining = parseFloat(data.remaining_quantity);
    if (remaining <= 0) {
        warning.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Quota épuisé';
    } else if (remaining < 10) {
        warning.innerHTML = `<i class="fas fa-warning"></i> Reste: ${remaining}`;
    } else {
        warning.style.display = 'none';
    }
}

// Update line subscription info
function updateLineSubscriptionInfo(row, productId) {
    const subscription = customerSubscriptions[productId];
    if (subscription) {
        addSubscriptionBadge(row, subscription);
        showQuantityWarning(row, subscription);
    } else {
        removeSubscriptionBadge(row);
    }
}

// Quantity input validation and stock update
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('quantity-input')) {
        const row = e.target.closest('tr');
        const productSelect = row.querySelector('.product-select');
        
        if (productSelect && productSelect.value) {
            const productId = productSelect.value;
            
            // Update stock display
            updateStockDisplay(row, productId);
            
            // Check subscription limits
            const subscription = customerSubscriptions[productId];
            if (subscription) {
                const quantity = parseFloat(e.target.value) || 0;
                const remaining = parseFloat(subscription.remaining_quantity);
                
                if (quantity > remaining) {
                    e.target.style.borderColor = '#dc3545';
                    e.target.title = `Quantité demandée (${quantity}) dépasse le quota restant (${remaining})`;
                } else {
                    e.target.style.borderColor = '';
                    e.target.title = '';
                }
            }
        }
        
        calculateLineTotal(row);
    }
});

// Calculate line total with proper formatting
function calculateLineTotal(row) {
    const quantityInput = row.querySelector('.quantity-input') || row.querySelector('[name*="-quantity"]');
    const priceInput = row.querySelector('.price-input') || row.querySelector('[name*="-unit_price"]');
    const totalCell = row.querySelector('.line-total');
    
    if (quantityInput && priceInput && totalCell) {
        const quantity = parseFloat(quantityInput.value) || 0;
        const unitPrice = parseFloat(priceInput.value) || 0;
        const total = quantity * unitPrice;
        
        totalCell.textContent = total.toFixed(2) + ' DA';
        
        // Update stock display when quantity changes
        const productSelect = row.querySelector('.product-select');
        if (productSelect && productSelect.value) {
            updateStockDisplay(row, productSelect.value);
        }
        
        calculateTotals();
    }
}

// Add event listeners to existing rows
function addLineEventListeners(row) {
    const quantityInput = row.querySelector('.quantity-input') || row.querySelector('[name*="-quantity"]');
    const priceInput = row.querySelector('.price-input') || row.querySelector('[name*="-unit_price"]');
    
    if (quantityInput) {
        quantityInput.addEventListener('input', () => calculateLineTotal(row));
        quantityInput.addEventListener('change', () => calculateLineTotal(row));
    }
    if (priceInput) {
        priceInput.addEventListener('input', () => calculateLineTotal(row));
        priceInput.addEventListener('change', () => calculateLineTotal(row));
    }
}

// Calculate invoice totals with automatic timbre calculation
function calculateTotals() {
    let subtotal = 0;
    
    document.querySelectorAll('.invoice-line-row:not([style*="display: none"])').forEach(row => {
        const totalCell = row.querySelector('.line-total');
        if (totalCell) {
            const lineTotal = parseFloat(totalCell.textContent.replace(' DA', '')) || 0;
            subtotal += lineTotal;
        }
    });
    
    const discountInput = document.getElementById('id_discount_amount');
    const timbreInput = document.getElementById('id_timbre_fiscal');
    const timbreDisplayInput = document.getElementById('timbre-display-input');
    const otherTaxesInput = document.getElementById('id_other_taxes');
    const paymentMethodSelect = document.querySelector('[name="payment_method"]');
    
    const discount = discountInput ? (parseFloat(discountInput.value) || 0) : 0;
    const otherTaxes = otherTaxesInput ? (parseFloat(otherTaxesInput.value) || 0) : 0;
    const paymentMethod = paymentMethodSelect ? paymentMethodSelect.value : '';
    
    const discountedSubtotal = Math.max(0, subtotal - discount);
    
    // Apply TVA only if customer has legal information
    const effectiveTvaRate = currentCustomerHasLegalInfo ? TVA_RATE : 0;
    const tva = discountedSubtotal * effectiveTvaRate;
    
    // Calculate timbre fiscal automatically based on (HT + TVA) and payment method
    const amountHtPlusTva = discountedSubtotal + tva;
    const timbre = calculateTimbreFiscal(amountHtPlusTva, paymentMethod);
    
    // Update hidden timbre input and display
    if (timbreInput) {
        timbreInput.value = timbre.toFixed(2);
    }
    if (timbreDisplayInput) {
        timbreDisplayInput.value = timbre.toFixed(2) + ' DA';
    }
    
    const total = discountedSubtotal + tva + timbre + otherTaxes;
    
    // Update display elements
    const subtotalDisplay = document.getElementById('subtotal-display');
    const discountDisplay = document.getElementById('discount-display');
    const tvaDisplay = document.getElementById('tva-display');
    const timbreDisplay = document.getElementById('timbre-display');
    const otherTaxesDisplay = document.getElementById('other-taxes-display');
    const totalDisplay = document.getElementById('total-display');
    
    if (subtotalDisplay) subtotalDisplay.textContent = (isNaN(subtotal) ? 0 : subtotal).toFixed(2) + ' DA';
    if (discountDisplay) discountDisplay.textContent = (isNaN(discount) ? 0 : discount).toFixed(2) + ' DA';
    if (tvaDisplay) tvaDisplay.textContent = (isNaN(tva) ? 0 : tva).toFixed(2) + ' DA';
    if (timbreDisplay) timbreDisplay.textContent = (isNaN(timbre) ? 0 : timbre).toFixed(2) + ' DA';
    if (otherTaxesDisplay) otherTaxesDisplay.textContent = (isNaN(otherTaxes) ? 0 : otherTaxes).toFixed(2) + ' DA';
    if (totalDisplay) totalDisplay.textContent = (isNaN(total) ? 0 : total).toFixed(2) + ' DA';
}

// Payment method change handler
document.addEventListener('change', function(e) {
    if (e.target.name === 'payment_method') {
        calculateTotals();
    }
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Update TVA label with current rate
    const tvaLabel = document.getElementById('tva-label');
    if (tvaLabel) {
        tvaLabel.textContent = `T.V.A. (${COMPANY_DATA.tva_rate}%):`;
    }
    
    // Add event listeners to existing rows
    document.querySelectorAll('.invoice-line-row').forEach(row => {
        addLineEventListeners(row);
        
        // Calculate initial line totals for existing data
        const quantityInput = row.querySelector('[name*="-quantity"]');
        const priceInput = row.querySelector('[name*="-unit_price"]');
        if (quantityInput && priceInput && (quantityInput.value || priceInput.value)) {
            calculateLineTotal(row);
        }
    });
    
    // Add event listeners to payment method field
    const paymentMethodSelect = document.querySelector('[name="payment_method"]');
    if (paymentMethodSelect) {
        paymentMethodSelect.addEventListener('change', calculateTotals);
    }
    
    // Add event listeners to summary fields
    ['id_discount_amount', 'id_other_taxes'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('input', calculateTotals);
            element.addEventListener('change', calculateTotals);
        }
    });
    
    // Check if customer is already selected (for edit mode)
    const customerSelect = document.querySelector('[name="customer"]');
    if (customerSelect && customerSelect.value) {
        currentCustomerId = customerSelect.value;
        loadCustomerSubscriptions(customerSelect.value);
        checkCustomerLegalInfo(customerSelect.value);
    }
    
    // Initial calculation
    calculateTotals();
});
</script>
{% endblock %}