{% extends 'base.html' %}
{% load humanize %}

{% block title %}Rapport produits{% endblock %}

{% block extra_css %}
<style>
    .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 2rem;
    }
    .stat-card {
        border-left: 4px solid;
        transition: transform 0.2s ease;
    }
    .stat-card:hover {
        transform: translateY(-2px);
    }
    .stat-card.products { border-left-color: #4e73df; }
    .stat-card.services { border-left-color: #1cc88a; }
    .stat-card.low-stock { border-left-color: #f6c23e; }
    .stat-card.critical { border-left-color: #e74a3b; }
    .metric-number {
        font-size: 2rem;
        font-weight: 700;
        color: #5a5c69;
    }
    .metric-label {
        font-size: 0.85rem;
        color: #858796;
        text-transform: uppercase;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-chart-bar me-2"></i>Rapport produits détaillé
        </h1>
        <div>
            <a href="{% url 'reports:export_csv' 'products' %}" class="btn btn-success me-2">
                <i class="fas fa-download me-2"></i>Exporter CSV
            </a>
            <a href="{% url 'reports:index' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Retour
            </a>
        </div>
    </div>
    
    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card products shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="metric-label">Total Produits</div>
                            <div class="metric-number" id="totalProducts">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-boxes fa-2x text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card services shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="metric-label">Services</div>
                            <div class="metric-number" id="totalServices">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-cogs fa-2x text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card low-stock shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="metric-label">Stock Faible</div>
                            <div class="metric-number" id="lowStockCount">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card critical shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="metric-label">Critique/Élevé</div>
                            <div class="metric-number" id="criticalCount">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-radiation fa-2x text-danger"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Charts Row -->
    <div class="row mb-4">
        <!-- Product Distribution by Category -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Répartition par catégorie</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Hazard Level Distribution -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Niveaux de danger</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="hazardChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Additional Charts Row -->
    <div class="row mb-4">
        <!-- Price Range Distribution -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Répartition des prix</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="priceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Stock Status Overview -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">État des stocks</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="stockChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Top Products Table -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Produits les plus chers</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="topProductsTable">
                    <thead class="table-light">
                        <tr>
                            <th>Code</th>
                            <th>Nom</th>
                            <th>Catégorie</th>
                            <th>Prix unitaire</th>
                            <th>Stock</th>
                            <th>Niveau danger</th>
                            <th>Statut</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Table rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
// Sample data - Replace with actual data from Django context
const productData = {{ products_data|safe }};

// Process data for statistics
const stats = {
    totalProducts: productData.filter(p => !p.isService).length,
    totalServices: productData.filter(p => p.isService).length,
    lowStockCount: productData.filter(p => p.isLowStock).length,
    criticalCount: productData.filter(p => p.hazardLevel === 'critical' || p.hazardLevel === 'high').length
};

// Update statistics cards
document.getElementById('totalProducts').textContent = stats.totalProducts;
document.getElementById('totalServices').textContent = stats.totalServices;
document.getElementById('lowStockCount').textContent = stats.lowStockCount;
document.getElementById('criticalCount').textContent = stats.criticalCount;

// Chart configurations
Chart.defaults.font.family = 'inherit';
Chart.defaults.color = '#858796';

// Category Distribution Chart
const categoryData = productData.reduce((acc, product) => {
    acc[product.category] = (acc[product.category] || 0) + 1;
    return acc;
}, {});

const categoryChart = new Chart(document.getElementById('categoryChart'), {
    type: 'doughnut',
    data: {
        labels: Object.keys(categoryData),
        datasets: [{
            data: Object.values(categoryData),
            backgroundColor: [
                '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
                '#858796', '#5a5c69', '#2e59d9', '#17a2b8', '#fd7e14'
            ],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: { padding: 20 }
            }
        },
        cutout: '60%'
    }
});

// Hazard Level Chart
const hazardData = productData.reduce((acc, product) => {
    acc[product.hazardLevelDisplay] = (acc[product.hazardLevelDisplay] || 0) + 1;
    return acc;
}, {});

const hazardChart = new Chart(document.getElementById('hazardChart'), {
    type: 'bar',
    data: {
        labels: Object.keys(hazardData),
        datasets: [{
            label: 'Nombre de produits',
            data: Object.values(hazardData),
            backgroundColor: [
                '#858796', '#36b9cc', '#f6c23e', '#e74a3b', '#dc3545'
            ],
            borderColor: [
                '#6c757d', '#2c9faf', '#dda20a', '#c0392b', '#bd2130'
            ],
            borderWidth: 1
        }]
    },
    options: {
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: { stepSize: 1 }
            }
        }
    }
});

// Price Range Distribution
const priceRanges = {
    '0-1000': 0,
    '1000-5000': 0,
    '5000-10000': 0,
    '10000-50000': 0,
    '50000+': 0
};

productData.forEach(product => {
    const price = product.price;
    if (price < 1000) priceRanges['0-1000']++;
    else if (price < 5000) priceRanges['1000-5000']++;
    else if (price < 10000) priceRanges['5000-10000']++;
    else if (price < 50000) priceRanges['10000-50000']++;
    else priceRanges['50000+']++;
});

const priceChart = new Chart(document.getElementById('priceChart'), {
    type: 'bar',
    data: {
        labels: Object.keys(priceRanges).map(range => range + ' DA'),
        datasets: [{
            label: 'Nombre de produits',
            data: Object.values(priceRanges),
            backgroundColor: '#4e73df',
            borderColor: '#2e59d9',
            borderWidth: 1
        }]
    },
    options: {
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: { stepSize: 1 }
            }
        }
    }
});

// Stock Status Chart
const stockStatus = {
    'En stock': productData.filter(p => !p.isService && p.stock > 0 && !p.isLowStock).length,
    'Stock faible': productData.filter(p => p.isLowStock).length,
    'Rupture': productData.filter(p => !p.isService && p.stock === 0).length,
    'Services': productData.filter(p => p.isService).length
};

const stockChart = new Chart(document.getElementById('stockChart'), {
    type: 'pie',
    data: {
        labels: Object.keys(stockStatus),
        datasets: [{
            data: Object.values(stockStatus),
            backgroundColor: ['#1cc88a', '#f6c23e', '#e74a3b', '#36b9cc'],
            borderColor: '#fff',
            borderWidth: 2
        }]
    },
    options: {
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: { padding: 20 }
            }
        }
    }
});

// Populate top products table
const topProducts = productData
    .sort((a, b) => b.price - a.price)
    .slice(0, 10);

const tableBody = document.querySelector('#topProductsTable tbody');
topProducts.forEach(product => {
    const row = document.createElement('tr');
    
    const hazardBadgeClass = {
        'critical': 'danger',
        'high': 'warning',
        'medium': 'info',
        'low': 'secondary',
        'none': 'secondary'
    }[product.hazardLevel] || 'secondary';
    
    row.innerHTML = `
        <td><strong>${product.code}</strong></td>
        <td>${product.name}</td>
        <td>${product.category}</td>
        <td><strong>${product.price.toLocaleString('fr-FR')} DA</strong></td>
        <td>
            ${product.isService ? 
                '<span class="badge bg-info">Service</span>' : 
                `${product.stock} ${product.unit}${product.isLowStock ? ' <i class="fas fa-exclamation-triangle text-warning"></i>' : ''}`
            }
        </td>
        <td>
            <span class="badge bg-${hazardBadgeClass}">${product.hazardLevelDisplay}</span>
        </td>
        <td>
            <span class="status-indicator ${product.isActive ? 'active' : 'inactive'}"></span>
            ${product.isActive ? 'Actif' : 'Inactif'}
        </td>
    `;
    
    tableBody.appendChild(row);
});
</script>
{% endblock %}